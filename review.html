<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ทบทวนออเดอร์</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Kanit', sans-serif;
    }
    
    body {
      background-color: #fdf2f8;
      color: #374151;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    
    /* Desktop Header */
    header {
      padding: 1rem;
      background: pink;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    #back-btn {
      font-size: 2rem;
      color: white;
      text-decoration: none;
      padding: 4px 30px 20px 7px;
      background-color: #E282A8;
      border-radius: 50%;
      position: relative;
      height: 50px;
      width: 50px;
    }

    .top-nav img {
      width: 100px;
      height: auto;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .search-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    #search {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 30px;
      border: 1px solid #f0d6df;
      background-color: #fff9fa;
      outline: none;
      width: 200px;
      position: relative;
      margin-top: 10px;
      left: 35%;
    }

    #buy-more-btn {
      background-color: #E282A8;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      text-decoration: none;
      font-size: 0.9rem;
      white-space: nowrap;
      right: 70%;
      position: relative;
    }

    /* Mobile Header - 480px */
    .mobile-header {
      display: none;
      background: pink;
      padding: 10px 15px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .mobile-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    .mobile-back-btn {
      background-color: #E282A8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      position: absolute;
      top: 10px;
      left: 15px;
      z-index: 1001;
    }

    .mobile-menu-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #E282A8;
      cursor: pointer;
      position: absolute;
      top: 50px;
      left: 15px;
      z-index: 1001;
    }

    .mobile-logo {
      width: 80px;
      height: auto;
      margin: 0 auto;
      display: block;
      margin-top: 30px;
    }

    /* Slide Menu */
    .slide-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: white;
      z-index: 1002;
      transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .slide-menu.active {
      left: 0;
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .close-menu {
      background: none;
      border: none;
      font-size: 24px;
      color: #E282A8;
      cursor: pointer;
    }

    .menu-search {
      width: 100%;
      padding: 12px;
      border: 1px solid #f0d6df;
      border-radius: 25px;
      background-color: #fff9fa;
      outline: none;
      margin-bottom: 20px;
    }

    .menu-item {
      display: block;
      padding: 15px 0;
      color: #E282A8;
      text-decoration: none;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 500;
    }

    .menu-item:hover {
      background-color: #fdf2f8;
      padding-left: 10px;
      transition: all 0.3s ease;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    /* สไตล์สำหรับระบบรูปภาพหลายมุมมอง */
    .product-image-container {
      position: relative;
      display: inline-block;
      margin-right: 10px;
      min-width: 60px;
    }
    
    .image-switcher {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      display: none;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .product-image-container:hover .image-switcher {
      display: block;
    }
    
    .switcher-buttons {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .img-switch-btn {
      padding: 3px 6px;
      font-size: 0.7rem;
      background: #E282A8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
      white-space: nowrap;
    }
    
    .img-switch-btn:hover {
      background: #be185d;
    }

    .product-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #f1f5f9;
    }

    .product-name {
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
    }

    /* Responsive Design */
    @media screen and (max-width: 480px) {
      /* Hide desktop header */
      header {
        display: none;
      }
      
      /* Show mobile header */
      .mobile-header {
        display: block;
      }

      .mobile-header img {
        display: block;
        position: relative;
        bottom: 20px;
      }
      
      /* ปรับขนาดรูปภาพสำหรับมือถือ */
      .product-img {
        width: 50px;
        height: 50px;
      }

      .img-switch-btn {
        padding: 2px 4px;
        font-size: 0.6rem;
      }
      
      .image-switcher {
        padding: 3px;
      }
    }

    @media screen and (min-width: 481px) and (max-width: 768px) {
      .top-nav {
        gap: 1rem;
      }
      
      .top-nav img {
        position: relative;
        transform: none;
        order: 1;
        width: 80px;
        margin: 0 auto;
        left: 28%;
      }
      
      #back-btn {
        order: 0;
        background-color: #E282A8;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        padding: 0.5px 10px 20px 5px;
        position: relative;
        left: 30px;
        font-size: 40px;
      }
      
      .search-container {
        order: 2;
        width: 100%;
        justify-content: flex-end;
      }
      
      #search {
        width: 100%;
        position: relative;
        max-width: 90px;
        left: 47%;
        margin-top: 12px;
      }
      
      #buy-more-btn {
        position: relative;
        right: 28.5%;
      }
    }

    .header-image-container {
      width: 100%;
      overflow: hidden;
    }
    
    .header-image {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    h2 {
      background-color: #fce7f3;
      color: #be185d;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      border-bottom: 2px solid #f3e8ff;
    }
    
    .table-container {
      padding: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }
    
    th {
      background-color: #fdf2f8;
      color: #be185d;
      font-weight: 500;
    }
    
    #total {
      text-align: center;
      padding: 15px;
      font-weight: 600;
      font-size: 1.3rem;
      color: #be185d;
      background-color: #fdf2f8;
      margin: 20px;
      border-radius: 8px;
    }
    
    .form-section {
      max-width: 400px;
      margin: 0 auto 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #f1f5f9;
    }
    
    .form-section h3 {
      color: #be185d;
      margin-bottom: 15px;
      text-align: center;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background-color: #fafafa;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .submit-btn {
      width: 100%;
      background-color: #ec4899;
      color: white;
      font-size: 1rem;
      margin-top: 10px;
    }
    
    .submit-btn:hover {
      background-color: #db2777;
    }
    
    .btn-group {
      display: flex;
      gap: 5px;
    }
    
    .btn-plus {
      background-color: #10b981;
      color: white;
    }
    
    .btn-minus {
      background-color: #f59e0b;
      color: white;
    }
    
    .btn-remove {
      background-color: #ef4444;
      color: white;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 10px;
      color: #6b7280;
    }
    
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      text-align: center;
    }
    
    .status-success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .status-error {
      background-color: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    @media (max-width: 768px) {
      th, td {
        padding: 8px 10px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Desktop Header -->
  <header>
    <div class="top-nav">
      <a href="javascript:void(0)" id="back-btn" onclick="goBack()">←</a>
      <img src="im/Logo2.png" alt="logo">
      <div class="search-container">
        <input id="search" type="text" placeholder="🔍 ค้นหาสินค้า...">
        <a href="jee.html" id="buy-more-btn">ซื้อจี้เพิ่มเติม</a>
      </div>
    </div>
  </header>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-nav">
      <a href="javascript:void(0)" class="mobile-back-btn" onclick="goBack()">←</a>
      <button class="mobile-menu-btn" onclick="toggleMenu()">☰</button>
      <img src="im/Logo2.png" alt="logo" class="mobile-logo">
    </div>
  </div>

  <!-- Slide Menu -->
  <div class="slide-menu" id="slideMenu">
    <div class="menu-header">
      <h3 style="color: #E282A8;">เมนู</h3>
      <button class="close-menu" onclick="toggleMenu()">×</button>
    </div>
    <input type="text" class="menu-search" id="menuSearch" placeholder="🔍 ค้นหาสินค้า...">
    <a href="jee.html" class="menu-item">ซื้อจี้เพิ่มเติม</a>
    <a href="index.html" class="menu-item">หน้าหลัก</a>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <div class="container">
    <h2>รายการที่สามารถสั่งซื้อได้</h2>
    
    <div class="table-container">
      <table id="review-table"></table>
    </div>
    
    <p id="total"></p>

    <div class="form-section">
      <h3>ข้อมูลการจัดส่ง</h3>
      <input id="fullname" type="text" placeholder="ชื่อ-นามสกุล" required>
      <input id="phone" type="tel" placeholder="เบอร์โทรศัพท์" required>
      <textarea id="address" placeholder="ที่อยู่สำหรับจัดส่ง" required></textarea>
      <button class="submit-btn" onclick="submitOrder()">ยืนยันสั่งซื้อ</button>
      <div id="loading" class="loading">กำลังประมวลผล...</div>
      <div id="status-message" class="status-message"></div>
    </div>
  </div>

  <script>
    // ระบบจัดการตะกร้าและสต็อก
    const store = {
      // ฟังก์ชันจัดการตะกร้าสินค้า
      getCart() {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      },
      setCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
      },
      clearCart() {
        localStorage.removeItem("cart");
      },
      
      // ฟังก์ชันจัดการสต็อกสินค้า
      getProductStock() {
        return JSON.parse(localStorage.getItem("productStock") || "[]");
      },
      setProductStock(stock) {
        localStorage.setItem("productStock", JSON.stringify(stock));
      },
      
      // ฟังก์ชันจัดการเลขคิว
      getLastQueue() {
        const lastQueue = localStorage.getItem("lastQueue");
        const parsed = parseInt(lastQueue);
        // เพิ่มการตรวจสอบ NaN และให้ค่าเริ่มต้นเป็น 0
        return (isNaN(parsed) || parsed === null || parsed === undefined) ? 0 : parsed;
      },
      setLastQueue(queueNumber) {
        // ตรวจสอบว่าเป็นตัวเลขที่ถูกต้อง
        const validNumber = isNaN(queueNumber) ? 0 : queueNumber;
        localStorage.setItem("lastQueue", validNumber.toString());
      },
      getNextQueueNumber() {
        const lastQueue = this.getLastQueue();
        const nextQueue = lastQueue + 1;
        // ตรวจสอบอีกครั้งก่อนส่งคืน
        return isNaN(nextQueue) ? 1 : nextQueue;
      },
      generateQueueCode() {
        const queueNumber = this.getNextQueueNumber();
        this.setLastQueue(queueNumber);
        // ตรวจสอบก่อนสร้าง queue code
        return isNaN(queueNumber) ? "A1" : `A${queueNumber}`;
      }, // เพิ่ม comma ตรงนี้
      
      // ฟังก์ชันจัดการออเดอร์
      setPendingOrder(order) {
        localStorage.setItem("pendingOrder", JSON.stringify(order));
      },
      getPendingOrder() {
        return JSON.parse(localStorage.getItem("pendingOrder"));
      },

      // ฟังก์ชันดึงรูปภาพจากทุกโฟลเดอร์
      getImageFromAllFolders: function(imgName) {
        // ถ้า imgName เป็น URL เต็ม ให้ใช้ URL นั้นเลย
        if (imgName && (imgName.startsWith('http') || imgName.includes('data:image'))) {
          return imgName;
        }
        
        // ถ้า imgName มี path เต็มอยู่แล้ว ให้ใช้ path นั้นเลย
        if (imgName && imgName.includes('/')) {
          return imgName;
        }
        
        // ถ้าไม่มี imgName ให้ใช้รูป fallback
        if (!imgName) {
          return 'im/default.jpg';
        }
        
        // รายการโฟลเดอร์ทั้งหมด
        const folders = [
          'im/', 
          'im2/จี้เบอร์2 (สีทอง)/', 
          'im3/จี้เบอร์2 (เงิน)/', 
          'im4/จี้เบอร์3/จี้เบอร์ 3 (เงิน)/',
          'im4/จี้เบอร์3/จี้เบอร์3 (ทอง)/', 
          'im5/จี้เบอร์4/จี้เบอร์ 4 (เงิน)/', 
          'im5/จี้เบอร์4/จี้เบอร์4 (ทอง)/',
          'im6/จี้เบอร์ 5/เงิน/',
          'im6/จี้เบอร์ 5/ทอง/'
        ];
        
        // ลองโฟลเดอร์แรกก่อน (im/) เพราะส่วนใหญ่ประชากะอยู่ที่นี่
        return folders[0] + imgName;
      }
    };

    // องค์ประกอบ DOM
    const table = document.getElementById("review-table");
    const totalEl = document.getElementById("total");
    const loadingEl = document.getElementById("loading");
    const statusEl = document.getElementById("status-message");

    // ฟังก์ชันแสดงตะกร้าสินค้า
    // เพิ่มการตรวจสอบข้อผิดพลาดใน renderCart
    function renderCart() {
      try {
        const cart = store.getCart();
        const productStock = store.getProductStock();
        
        if (cart.length === 0) {
          table.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center;">ไม่มีสินค้าในตะกร้า</td>
            </tr>`;
          totalEl.textContent = "รวมทั้งหมด: 0 ฿";
          return;
        }

        let tableHTML = `
          <tr>
            <th>สินค้า</th>
            <th>ไซส์</th>
            <th>จำนวน</th>
            <th>ราคา</th>
            <th>จัดการ</th>
          </tr>`;

             cart.forEach((item, index) => {
          const stockItem = productStock.find(p => p.id === item.id);
          const currentStock = stockItem ? stockItem.stock : 0;
          const canIncrease = currentStock > 0;
          
          // ดึงรูปภาพจากทุกโฟลเดอร์
          const imgPath = store.getImageFromAllFolders(item.img);
          
          tableHTML += `
            <tr>
              <td style="display: flex; align-items: center;">
                <div class="product-image-container">
                  <img src="${imgPath}" 
                       alt="${item.name}" 
                       class="product-img" 
                       onerror="this.src='im/default.jpg'">
                </div>
                <span class="product-name">${item.name}</span>
              </td>
              <td>${item.size || '-'}</td>
              <td>${item.qty}</td>
              <td>${(item.qty * item.price).toLocaleString()} ฿</td>
              <td>
                <div class="btn-group">
                  <button class="btn-plus" onclick="changeQty(${index}, 1)" ${canIncrease ? '' : 'disabled'}>
                    ${canIncrease ? '+' : 'เต็ม'}
                  </button>
                  <button class="btn-minus" onclick="changeQty(${index}, -1)">-</button>
                  <button class="btn-remove" onclick="removeItem(${index})">ลบ</button>
                </div>
              </td>
            </tr>`;
        });

        table.innerHTML = tableHTML;
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        totalEl.textContent = `รวมทั้งหมด: ${total.toLocaleString()} ฿`;
      } catch (error) {
        console.error('Error rendering cart:', error);
        showStatus('เกิดข้อผิดพลาดในการแสดงตะกร้า', 'error');
      }
    }

    // ฟังก์ชันลบสินค้าออกจากตะกร้า
    function removeItem(index) {
      const cart = store.getCart();
      const itemToRemove = cart[index];
      
      // คืนสต็อกสินค้า
      const productStock = store.getProductStock();
      const stockIndex = productStock.findIndex(p => p.id === itemToRemove.id);
      
      if (stockIndex >= 0) {
        productStock[stockIndex].stock += itemToRemove.qty;
        store.setProductStock(productStock);
      }
      
      // ลบออกจากตะกร้า
      cart.splice(index, 1);
      store.setCart(cart);
      
      renderCart();
      showStatus(`บบ ${itemToRemove.name} ออกจากตะกร้าแล้ว`, "success");
    }

    // ฟังก์ชันเปลี่ยนจำนวนสินค้า
    function changeQty(index, delta) {
      const cart = store.getCart();
      const item = cart[index];
      
      // อัปเดตจำนวน
      item.qty += delta;
      
      // คำนว������ารเปลี่ยนแปลงสต็อก
      const productStock = store.getProductStock();
      const stockIndex = productStock.findIndex(p => p.id === item.id);
      
      if (stockIndex >= 0) {
        productStock[stockIndex].stock -= delta;
        store.setProductStock(productStock);
      }
      
      if (item.qty < 1) {
        cart.splice(index, 1);
      }
      
      store.setCart(cart);
      renderCart();
    }

    // ฟังก์ชันส่งออเดอร์
    function submitOrder() {
      const fullname = document.getElementById("fullname").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const cart = store.getCart();

      // ตรวจสอบข้อมูล
      if (!fullname || !phone || !address) {
        showStatus("กรุณากรอกข้อมูลให้ครบทุกช่อง", "error");
        return;
      }
      
      if (cart.length === 0) {
        showStatus("ไม่มีสินค้าในตะกร้า", "error");
        return;
      }

      loadingEl.style.display = "block";
      statusEl.style.display = "none";

      // สร้างเลขที่ออเดอร์
      const queueCode = store.generateQueueCode();

      // คำนวณยอดรวม
      const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

      // สร้างข้อมูลออเดอร์
      const orderData = {
        queueCode,
        fullname,
        phone,
        address,
        items: cart.map(item => {
          // ดึงรูปภาพปัจจุบันจาก DOM
          const imgElement = document.querySelector(`img[alt="${item.name}"]`);
          const currentImage = imgElement ? imgElement.src : item.img;
          
          return {
            id: item.id,
            name: item.name,
            price: item.price,
            qty: item.qty,
            size: item.size || '-',
            image: currentImage
          };
        }),
        total,
        date: new Date().toLocaleString('th-TH', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
      };

      // บันทึกออเดอร์
      store.setPendingOrder(orderData);
      
      // เคลียร์ตะกร้า
      store.clearCart();
      
      // ไปที่หน้า payment.html
      window.location.href = "payment.html";
    }

    // ฟังก์ชันแสดงสถานะ
    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      statusEl.style.display = "block";
      setTimeout(() => {
        statusEl.style.display = "none";
      }, 3000);
    }

    // ฟังก์ชันกลับหน้าเดิม
    function goBack() {
      window.history.back();
    }

    // โหลดตะกร้าเมื่อหน้าเว็บโหลดเสร็จ
    document.addEventListener('DOMContentLoaded', renderCart);

    // เพิ่มฟังก์ชันนี้ในส่วนท้ายของ script
function resetQueueNumber() {
  localStorage.setItem("lastQueue", "0");
  console.log("Queue number has been reset to 0");
}
    // Mobile menu functions
    function toggleMenu() {
      const slideMenu = document.getElementById('slideMenu');
      const overlay = document.getElementById('overlay');
      
      slideMenu.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Sync search boxes
    function syncSearchBoxes() {
      const desktopSearch = document.getElementById('search');
      const menuSearch = document.getElementById('menuSearch');
      
      if (desktopSearch && menuSearch) {
        desktopSearch.addEventListener('input', function() {
          menuSearch.value = this.value;
        });
        
        menuSearch.addEventListener('input', function() {
          desktopSearch.value = this.value;
        });
      }
    }

    // Initialize sync when page loads
    document.addEventListener('DOMContentLoaded', function() {
      renderCart();
      syncSearchBoxes();
    });

    // ... existing code ...

// เรียกใช้เมื่อเกิดปัญหา (สามารถเรียกใน console)
// resetQueueNumber();

  </script>
</body>
</html>

