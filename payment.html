<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
  <style>
    body { font-family: Mitr, sans-serif; background: #f9f9f9; padding: 20px; max-width: 600px; margin: auto; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; }
    input, select, button, textarea { width: 100%; padding: 8px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #00897b; color: #fff; border: none; font-size: 1rem; cursor: pointer; }
    .msg { margin-top: 20px; text-align: center; font-weight: bold; display: none; }
    .qr-section { text-align: center; margin: 10px 0; }
    .qr-section img { max-width: 200px; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>

  <table id="orderTable"><thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead><tbody></tbody></table>
  <p id="totalPrice"></p>

  <div class="qr-section">
    <p>üìå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
    <img src="im/qr.jpg" alt="QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">
  </div>

  <input id="payer" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" readonly>

  <label for="slip">üìé ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
  <input id="slip" type="file" accept="image/*" required>

  <input id="note" type="text" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
  <button id="payBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
  <div class="msg" id="doneMsg">‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</div>

  <script>
    const pending = JSON.parse(localStorage.getItem("pendingOrder") || "null");
    if (!pending) location.href = "index.html";

    document.getElementById("payer").value = pending.fullname;

    const tb = document.querySelector("#orderTable tbody");
    let total = 0;
    pending.cart.forEach(it => {
      const price = it.qty * it.price;
      total += price;
      tb.innerHTML += `<tr><td>${it.name}</td><td>${it.qty}</td><td>${price} ‡∏ø</td></tr>`;
    });
    document.getElementById("totalPrice").textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total} ‡∏ø`;

    document.getElementById("payBtn").onclick = async () => {
      const payer = document.getElementById("payer").value.trim();
      const note = document.getElementById("note").value.trim();
      const slip = document.getElementById("slip").files[0];

      if (!slip) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");

      try {
        await sendDiscord(pending, payer, note, slip);
        document.getElementById("doneMsg").style.display = "block";

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö confirm.html
        localStorage.setItem("lastOrder", JSON.stringify(pending.cart));
        localStorage.setItem("lastCustomer", pending.fullname);
        localStorage.setItem("lastQueue", pending.queueCode);

        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        localStorage.removeItem("pendingOrder");
        localStorage.removeItem("cart");

        // ‡∏£‡∏≠ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        setTimeout(() => {
          location.href = "confirm.html";
        }, 1500);
      } catch (e) {
        console.error(e);
        alert("‡∏™‡πà‡∏á Discord ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    };

    async function sendDiscord(data, payer, note, slipFile) {
      const url = "https://discord.com/api/webhooks/1394335643601080433/103SA4YLfjmrR7mpcEBP8vqa9_kyjDkJE1WhkkpQJpRghNCF1ggZg2n3qz3ejwyLYikP";
      const items = data.cart.map(i => `‚Ä¢ ${i.name} x${i.qty} = ${i.qty * i.price}‡∏ø`).join("\n");
      const total = data.cart.reduce((s, i) => s + i.price * i.qty, 0);
      const embed = {
        title: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
        description: items,
        fields: [
          { name: "üî¢ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà", value: data.queueCode, inline: true },
          { name: "üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", value: data.fullname, inline: true },
          { name: "üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå", value: data.phone, inline: true },
          { name: "üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", value: data.address, inline: false },
          { name: "üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°", value: `${total} ‡∏ø`, inline: true },
          { name: "üìù ‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞", value: payer, inline: true },
          ...(note ? [{ name: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", value: note, inline: false }] : [])
        ],
        footer: { text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå" },
        timestamp: new Date().toISOString()
      };

      const form = new FormData();
      form.append("payload_json", JSON.stringify({
        username: "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö order ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤",
        content: `üì• ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ${data.fullname}`,
        embeds: [embed]
      }));

      for (let i = 0; i < data.cart.length && i < 10; i++) {
        const item = data.cart[i];
        const imgPath = `im/${(item.id % 10 || 10)}.jpg`;
        try {
          const res = await fetch(imgPath);
          const blob = await res.blob();
          form.append(`files[${i}]`, blob, `${item.name}.jpg`);
        } catch (e) {
          console.warn("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", imgPath);
        }
      }

      const slipIndex = Math.min(data.cart.length, 10);
      form.append(`files[${slipIndex}]`, slipFile, "slip.jpg");

      const res = await fetch(url, { method: "POST", body: form });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`Discord Error: ${res.status} - ${msg}`);
      }
    }
  </script>
</body>
</html>
